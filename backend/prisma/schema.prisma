generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model OrdenServico {
  id           Int              @id @default(autoincrement())
  numero       Int
  name         String
  protocolo    String           @unique
  endereco     String           @default("")
  status       StatusOcorrencia @default(PENDENTE)
  ocorrenciaId Int?
  createdAt    DateTime         @default(now())
  disable      Boolean          @default(false)
  draft        Boolean          @default(true)
  ocorrencia   Ocorrencia?      @relation(fields: [ocorrenciaId], references: [id])
}

model User {
  id                     Int               @id @default(autoincrement())
  name                   String
  email                  String            @unique
  password               String
  role                   Role              @default(CIDADAO)
  telefone               String?
  ativo                  Boolean           @default(true)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  avaliacoes             Avaliacao[]
  comentarios            Comentario[]
  historicos             HistoricoStatus[]
  admins                 Admin?
  ocorrenciasResponsavel Ocorrencia[]      @relation("Responsavel")

  @@map("users")
}

model Admin {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@map("admins")
}

model Categoria {
  id          Int          @id @default(autoincrement())
  nome        String       @unique
  descricao   String
  createdAt   DateTime     @default(now())
  ocorrencias Ocorrencia[]
}

model Ocorrencia {
  id            Int                @id @default(autoincrement())
  titulo        String
  descricao     String
  gravidade     Gravidade          @default(BAIXA)
  status        StatusOcorrencia   @default(PENDENTE)
  protocolo     String             @unique
  categoriaId   Int
  responsavelId Int?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  endereco      String             @default("")
  disable       Boolean            @default(false)
  avaliacao     Avaliacao?
  comentarios   Comentario[]
  historicos    HistoricoStatus[]
  imagens       ImagemOcorrencia[]
  ordensServico OrdenServico[]
  categoria     Categoria          @relation(fields: [categoriaId], references: [id])
  responsavel   User?              @relation("Responsavel", fields: [responsavelId], references: [id])

  @@map("ocorrencias")
}

model ImagemOcorrencia {
  id           Int        @id @default(autoincrement())
  url          String
  ocorrenciaId Int
  createdAt    DateTime   @default(now())
  ocorrencia   Ocorrencia @relation(fields: [ocorrenciaId], references: [id], onDelete: Cascade)
}

model Comentario {
  id           Int        @id @default(autoincrement())
  texto        String
  ocorrenciaId Int
  userId       Int
  createdAt    DateTime   @default(now())
  ocorrencia   Ocorrencia @relation(fields: [ocorrenciaId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
}

model HistoricoStatus {
  id           Int              @id @default(autoincrement())
  status       StatusOcorrencia
  observacao   String?
  ocorrenciaId Int
  userId       Int
  createdAt    DateTime         @default(now())
  ocorrencia   Ocorrencia       @relation(fields: [ocorrenciaId], references: [id])
  user         User             @relation(fields: [userId], references: [id])
}

model Avaliacao {
  id           Int        @id @default(autoincrement())
  nota         Int
  comentario   String?
  ocorrenciaId Int        @unique
  userId       Int
  createdAt    DateTime   @default(now())
  ocorrencia   Ocorrencia @relation(fields: [ocorrenciaId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
}

enum Role {
  CIDADAO
  STAFF
  ADMIN
}

enum Gravidade {
  BAIXA
  MEDIA
  ALTA
}

enum StatusOcorrencia {
  PENDENTE
  EM_ANALISE
  ATRASADA
  CONCLUIDA
  CANCELADA
}
